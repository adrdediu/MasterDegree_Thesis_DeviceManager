{% extends 'devices/home.html' %}
{% load static %}

{% block content %}
<div class="container-fluid h-100 overflow-auto mt-2">
    <nav style="--bs-breadcrumb-divider: '>';background-color: #343a40;" aria-label="breadcrumb" class="sticky-top rounded" data-bs-theme="dark">
        <ol class="breadcrumb p-2 card-shadow rounded">
            <li class="breadcrumb-item"><a href="{% url 'homepage' %}" class="text-decoration-none">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'device_list' %}" class="text-decoration-none">Devices</a></li>
            <li class="breadcrumb-item active" aria-current="page">Device #{{ device.id }} - {{ device.name }}</li>
        </ol>
    </nav>
    <div class="row p-1">
        <div class="col">
            <h3 class="mb-3">Device #{{ device.id }} - {{ device.name }}</h3>
            <div class="row">
                <!-- First Column: General Information and Location -->
                <div class="col-md-8">
                    <!-- General Information Card -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h2 class="h5 mb-0">General Information</h2>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Name:</strong> {{ device.name }}</p>
                                    <p><strong>Description:</strong> {{ device.description }}</p>
                                    <p><strong>Serial Number:</strong> {{ device.serial_number }}</p>
                                    <p><strong>Owner:</strong> {{ device.owner.username|default:"N/A" }}</p>
                                    <p><strong>Category:</strong> {{ device.category.name }}</p>
                                    <p><strong>Subcategory:</strong> {{ device.subcategory.name }}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Created At:</strong> {{ device.created_at }}</p>
                                    <p><strong>Updated At:</strong> {{ device.updated_at }}</p>
                                    <p><strong>QR Code Applied:</strong> {% if device.is_qrcode_applied %}Yes{% else %}No{% endif %}</p>
                                </div>
                            </div>
                        </div>
                    </div>
        
                    <!-- Location Card -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h2 class="h5 mb-0">Location</h2>
                        </div>
                        <div class="card-body">
                            <p><strong>Building:</strong> {{ device.building.name }}</p>
                            <p><strong>Floor:</strong> {{ device.floor.name }}</p>
                            <p><strong>Room:</strong> {{ device.room.name }}</p>
                        </div>
                    </div>
                </div>
        
                <!-- Second Column: Device Actions and QR Code -->
                <div class="col-md-4">
                    <!-- Device Actions Card -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h2 class="h5 mb-0">Device Actions</h2>
                        </div>
                        <div class="card-body">
                            <button class="btn btn-warning edit-device mb-2 w-100" data-device-id="{{ device.id }}">
                                <i class="bi bi-pencil-fill"></i> Edit Device
                            </button>
                            <button class="btn btn-danger delete-device mb-2 w-100" data-device-id="{{ device.id }}">
                                <i class="bi bi-trash-fill"></i> Delete Device
                            </button>
                        </div>
                    </div>
        
                    <!-- QR Code Card -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h2 class="h5 mb-0">QR Code</h2>
                        </div>
                        <div class="card-body text-center">
                            {% if device.qrcode_url %}
                                <div class="card card-shadow bg-white p-1 rounded mb-3" style="display: inline-block;">
                                    <img src="{{ device.qrcode_url }}" class="img-fluid" alt="QR Code" style="max-width: 200px;">
                                </div>
                                <div class="d-grid gap-2">
                                    <a href="{% url 'download_qrcode' device.id %}" class="btn btn-primary">
                                        <i class="bi bi-download"></i> Download QR Code
                                    </a>
                                    <button id="regenerateQRCode" class="btn btn-warning">
                                        <i class="bi bi-arrow-clockwise"></i> Regenerate QR Code
                                    </button>
                                </div>
                            {% else %}
                                <p>No QR code available.</p>
                                <button id="generateQRCode" class="btn btn-primary w-100">
                                    <i class="bi bi-qr-code"></i> Generate QR Code
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="d-lg-none mb-3 pb-5">

            </div>
        </div>
    </div>


</div>

<!-- Edit Device Modal -->
 
<div class="modal fade" id="editDeviceModal" tabindex="-1" aria-labelledby="editDeviceModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
      <div class="modal-content">
          <div class="modal-header border-bottom-0 dev-man-bg-center card-shadow">
              <h5 class="modal-title text-white" id="editDeviceModalLabel">Edit Device</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <form id="editDeviceForm" method="post">
                  {% csrf_token %}
                  <input type="hidden" id="editDeviceId" name="device_id">
                  <div class="row">
                      <div class="col-md-6 mb-3">
                          <div class="bg-black p-3 rounded">
                              <h6 class="text-white mb-3">Device Information</h6>
                              <div class="mb-3">
                                  <label for="editDeviceName" class="form-label text-light">Name</label>
                                  <input type="text" class="form-control bg-dark text-light" id="editDeviceName" name="name" required>
                              </div>
                              <div class="mb-3">
                                  <label for="editDeviceDescription" class="form-label text-light">Description</label>
                                  <textarea class="form-control bg-dark text-light" id="editDeviceDescription" name="description" rows="3" required></textarea>
                              </div>
                              <div class="mb-3">
                                  <label for="editDeviceSerialNumber" class="form-label text-light">Serial Number</label>
                                  <input type="text" class="form-control bg-dark text-light" id="editDeviceSerialNumber" name="serial_number" required>
                              </div>
                          </div>
                      </div>
                      <div class="col-md-6 mb-3">
                          <div class="bg-black p-3 rounded">
                              <h6 class="text-white mb-3">Device Location</h6>
                              <div class="mb-3">
                                  <label for="editDeviceBuildingModal" class="form-label text-light">Building</label>
                                  <select class="form-select bg-dark text-light" id="editDeviceBuildingModal" name="building" required>
                                      <option value="">Select a building</option>
                                      {% for building in buildings %}
                                          <option value="{{ building.id }}">{{ building.acronym }}</option>
                                      {% endfor %}
                                  </select>
                              </div>
                              <div class="mb-3">
                                  <label for="editDeviceFloorModal" class="form-label text-light">Floor</label>
                                  <select class="form-select bg-dark text-light" id="editDeviceFloorModal" name="floor" required>
                                      <option value="">Select a Building first</option>
                                      {% for floor in floors %}
                                          <option value="{{ floor.id }}" data-building="{{ floor.building_id }}" style="display:none;">{{ floor.name }}</option>
                                      {% endfor %}
                                  </select>
                              </div>
                              <div class="mb-3">
                                  <label for="editDeviceRoomModal" class="form-label text-light">Room</label>
                                  <select class="form-select bg-dark text-light" id="editDeviceRoomModal" name="room" required>
                                      <option value="">Select a Building and a Floor first</option>
                                      {% for room in rooms %}
                                          <option value="{{ room.id }}" data-floor="{{ room.floor_id }}" style="display:none;">{{ room.name }}</option>
                                      {% endfor %}
                                  </select>
                              </div>
                          </div>
                      </div>
                  </div>
                  <div class="bg-black p-3 rounded mt-3">
                      <h6 class="text-white mb-3">Device Classification</h6>
                      <div class="row">
                          <div class="col-md-6 mb-3">
                              <label for="editDeviceCategoryModal" class="form-label text-light">Category</label>
                              <select class="form-select bg-dark text-light" id="editDeviceCategoryModal" name="category" required>
                                  <option value="">Select a category</option>
                                  {% for category in categories %}
                                      <option value="{{ category.id }}">{{ category.name }}</option>
                                  {% endfor %}
                              </select>
                          </div>
                          <div class="col-md-6 mb-3">
                              <label for="editDeviceSubcategoryModal" class="form-label text-light">Subcategory</label>
                              <select class="form-select bg-dark text-light" id="editDeviceSubcategoryModal" name="subcategory" required>
                                  <option value="">Select a Category first</option>
                                  {% for subcategory in subcategories %}
                                      <option value="{{ subcategory.id }}" data-category="{{ subcategory.category_id }}" style="display:none;">{{ subcategory.name }}</option>
                                  {% endfor %}
                              </select>
                          </div>
                      </div>
                  </div>
              </form>
          </div>
          <div class="modal-footer border-top-0">
              <button type="button" class="btn btn-secondary" id="resetEditForm">Reset</button>
              <button type="submit" form="editDeviceForm" class="btn btn-primary">Save Changes</button>
          </div>
      </div>
  </div>
</div>


{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Edit Device
    document.querySelector('.edit-device').addEventListener('click', function() {
        const deviceId = this.getAttribute('data-device-id');
        editDevice(deviceId);
    });

    // Delete Device
    document.querySelector('.delete-device').addEventListener('click', function() {
        const deviceId = this.getAttribute('data-device-id');
        deleteDevice(deviceId);
    });

    // QR Code regeneration
    var regenerateButton = document.getElementById('regenerateQRCode');

    function handleQRCodeGeneration(action) {
        fetch(`/api/device/{{ device.id }}/qrcode/${action}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlertAndReload('QR code successfully '+ action + 'd!','success');
            } else {
                showAlert('Failed to ' + action + ' QR code: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('An error occurred while ' + action + 'ing the QR code', 'error');
        });
    }

    if (regenerateButton) {
        regenerateButton.addEventListener('click', function() {
            showConfirmation('Regenerate QR Code', 'Are you sure you want to regenerate the QR code?', 'Yes, regenerate it', 'Cancel')
            .then((result) => {
                if (result.isConfirmed) {
                    handleQRCodeGeneration('regenerate');
                }
            });
        });
    }


    // Add event listener for the download QR code button
  const downloadQRCodeBtn = document.querySelector('a[href^="{% url 'download_qrcode' device.id %}"]');
  if (downloadQRCodeBtn) {
      downloadQRCodeBtn.addEventListener('click', function(event) {
          event.preventDefault();
          
          showConfirmation('Download QR Code', 'Are you sure you want to download the QR code?', 'Yes, download it', 'Cancel')
          .then((result) => {
              if (result.isConfirmed) {
                  showAlert('Preparing QR code for download...', 'info');
                  
                  fetch(this.href)
                      .then(response => {
                          if (response.ok) {
                              // Trigger the download
                              window.location.href = this.href;
                              showAlert('QR code downloaded successfully!', 'success');
                          } else {
                              return response.json().then(data => {
                                  throw new Error(data.error || 'Unknown error occurred');
                              });
                          }
                      })
                      .catch(error => {
                          console.error('Error:', error);
                          if (error.message === 'Device not found') {
                              showAlert('Device not found. Please check if the device exists.', 'error');
                          } else if (error.message === 'Failed to fetch QR code image') {
                              showAlert('Failed to download QR code. Please regenerate it.', 'error');
                          } else {
                              showAlert('An unexpected error occurred. Please try again later.', 'error');
                          }
                      });
              }
          });
      });
  }


    function editDevice(deviceId) {
        fetch(`{% url 'edit_device' %}?device_id=${deviceId}`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
              console.log(data.device)
                window.editingDevice = data.device;
                populateEditForm(data.device);
                var editDeviceModal = new bootstrap.Modal(document.getElementById('editDeviceModal'));
                editDeviceModal.show();
            } else {
                Swal.fire('Error', data.message || 'Failed to load device data', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire('Error', 'An unexpected error occurred', 'error');
        });
    }

    function populateEditForm(device) {
        document.getElementById('editDeviceId').value = device.id;
        document.getElementById('editDeviceName').value = device.name;
        document.getElementById('editDeviceDescription').value = device.description;
        document.getElementById('editDeviceSerialNumber').value = device.serial_number;
        
        const categorySelect = document.getElementById('editDeviceCategoryModal');
        categorySelect.value = device.category;
        updateOptions('editDeviceSubcategoryModal', 'category', device.category);
        
        const buildingSelect = document.getElementById('editDeviceBuildingModal');
        buildingSelect.value = device.building;
        updateOptions('editDeviceFloorModal', 'building', device.building);
        
        document.getElementById('editDeviceSubcategoryModal').value = device.subcategory;
        document.getElementById('editDeviceFloorModal').value = device.floor;

        updateOptions('editDeviceRoomModal', 'floor', device.floor);
        document.getElementById('editDeviceRoomModal').value = device.room;
    }
    
    function updateOptions(selectId, parentAttribute, parentValue) {
        const select = document.getElementById(selectId);
        Array.from(select.options).forEach(option => {
            if (option.dataset[parentAttribute] === parentValue.toString()) {
                option.style.display = '';
            } else {
                option.style.display = 'none';
            }
        });
    }

    // Add reset functionality
    document.getElementById('resetEditForm').addEventListener('click', function() {
        if (window.editingDevice) {
            populateEditForm(window.editingDevice);
        }
    });

    // Edit Device form submission
    const editDeviceForm = document.getElementById('editDeviceForm');
    if (editDeviceForm) {
        editDeviceForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(this);

            fetch('{% url "edit_device" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Success', 'Device updated successfully', 'success').then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire('Error', data.message || 'Failed to update device', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'An unexpected error occurred', 'error');
            });
        });
    }

    // Update event listeners
    document.getElementById('editDeviceCategoryModal').addEventListener('change', function() {
        updateOptions('editDeviceSubcategoryModal', 'category', this.value);
        document.getElementById('editDeviceSubcategoryModal').value = '';
    });

    document.getElementById('editDeviceBuildingModal').addEventListener('change', function() {
        updateOptions('editDeviceFloorModal', 'building', this.value);
        document.getElementById('editDeviceFloorModal').value = '';
        document.getElementById('editDeviceRoomModal').value = '';
    });

    document.getElementById('editDeviceFloorModal').addEventListener('change', function() {
        updateOptions('editDeviceRoomModal', 'floor', this.value);
        document.getElementById('editDeviceRoomModal').value = '';
    });


    function deleteDevice(device_id) {
        Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`{% url "delete_device" %}`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        'device_id': device_id
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire(
                            'Deleted!',
                            'The device has been deleted.',
                            'success'
                        ).then(() => {
                            window.location.href = "{% url 'device_list' %}";
                        });
                    } else {
                        Swal.fire(
                            'Error!',
                            data.message || 'An error occurred while deleting the device.',
                            'error'
                        );
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire(
                        'Error!',
                        'An error occurred while deleting the device.',
                        'error'
                    );
                });
            }
        });
    }
});
</script>
{% endblock %}

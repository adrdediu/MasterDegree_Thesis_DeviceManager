{% extends "devices/home.html" %}
{% load static %}

{% block content %}
<div class="container-fluid h-100 overflow-auto mt-2" style="overflow-y: auto;">
    <nav style="--bs-breadcrumb-divider: '>';background-color: #343a40;;" aria-label="breadcrumb" class="sticky-top  rounded" data-bs-theme="dark">
        <ol class="breadcrumb  p-2 card-shadow rounded">
          <li class="breadcrumb-item"><a href="{% url 'homepage' %}" class="text-decoration-none">Home</a></li>
          <li class="breadcrumb-item"><a href="{% url 'inventory_management' %}" class="text-decoration-none">Inventory Management</a></li>
          <li class="breadcrumb-item active" aria-current="page">Inventory #{{ inventory.id }}</li>
        </ol>
    </nav>
    
    <div class="row p-1">
        <div class="col">
            <h3 class="mb-3">Inventory Details</h3>
    
            <div class="row mb-3">
                <!-- General Information Card -->
                <div class="col-md-8">
                    <div class="card h-100">
                        <div class="card-header">
                            <h2 class="h5 mb-0">General Information</h2>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>ID:</strong> {{ inventory.id }}</p>
                                    <p><strong>Creator:</strong> {{ inventory.creator.username }}</p>
                                    <p><strong>Building:</strong> {{ inventory.building.name }}</p>
                                    <p><strong>Start Date:</strong> {{ inventory.start_date }}</p>
                                    <p><strong>End Date:</strong> {{ inventory.end_date|default:"Not ended" }}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Status:</strong> 
                                        {% if inventory.status == 'ACTIVE' %}
                                            <span class="badge text-success bg-light border border-success"><i class="bi bi-play-circle-fill me-1"></i>Active</span>
                                        {% elif inventory.status == 'PAUSED' %}
                                            <span class="badge bg-warning text-dark"><i class="bi bi-pause-circle-fill me-1"></i>Paused</span>
                                        {% elif inventory.status == 'CANCELED' %}
                                            <span class="badge bg-danger"><i class="bi bi-x-circle-fill me-1"></i>Canceled</span>
                                        {% elif inventory.status == 'COMPLETED' %}
                                            <span class="badge bg-success text-white"><i class="bi bi-check-circle-fill me-1"></i>Completed</span>
                                        {% elif inventory.status == 'UNKNOWN' %}
                                            <span class="badge bg-secondary text-white"><i class="bi bi-question-circle-fill me-1"></i>Unknown</span>
                                        {% endif %}
                                    </p>
                                    <p><strong>Scope:</strong> {{ inventory.get_scope_display }}</p>
                                    <p><strong>Total Devices:</strong> {{ total_devices }}</p>
                                    <p><strong>Scanned Devices:</strong> {{ total_scanned }} / {{ total_devices }}</p>
                                </div>
                            </div>
                            <div class="progress mt-3">
                                <div class="progress-bar" role="progressbar" style="width: {% widthratio total_scanned total_devices 100 %}%;" aria-valuenow="{{ total_scanned }}" aria-valuemin="0" aria-valuemax="{{ total_devices }}">
                                    {% widthratio total_scanned total_devices 100 %}%
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
        
                <!-- Actions Card -->
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h2 class="h5 mb-0">Actions</h2>
                        </div>
                        <div class="card-body d-flex flex-column justify-content-center">
                            {% if inventory.status == 'ACTIVE' %}
                                <button class="btn btn-warning mb-2 pause-resume" data-inventory-id="{{ inventory.id }}" data-action="pause">
                                    <i class="bi bi-pause-fill"></i> Pause Inventory
                                </button>
                            {% elif inventory.status == 'PAUSED' %}
                                <button class="btn btn-success mb-2 pause-resume" data-inventory-id="{{ inventory.id }}" data-action="resume">
                                    <i class="bi bi-play-fill"></i> Resume Inventory
                                </button>
                            {% endif %}
                            {% if inventory.status == 'ACTIVE' or inventory.status == 'PAUSED' %}
                                <button class="btn btn-secondary mb-2 cancel" data-inventory-id="{{ inventory.id }}">
                                    <i class="bi bi-x-circle-fill"></i> Cancel Inventory
                                </button>
                            {% endif %}
                            <button class="btn btn-primary mb-2 generate-report" data-inventory-id="{{ inventory.id }}">
                                <i class="bi bi-file-earmark-text"></i> Generate Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        
            <!-- Rooms and Devices Section -->
            {% for room_data in rooms_data %}
            <div class="card mb-3">
                <div class="card-header">
                    <h2 class="h5 mb-0">Room {{ room_data.room.name }} - Floor {{ room_data.room.floor.name }}</h2>
                </div>
                <div class="card-body">
                    <p><strong>Scanned Devices:</strong> {{ room_data.scanned_devices|length }} / {{ room_data.devices|length }}</p>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Serial Number</th>
                                    <th>Category</th>
                                    <th>Subcategory</th>
                                    <th>Owner</th>
                                    <th>Status</th>
                                    <th>Scan Date</th>
                                </tr>
                                <tr class="search-row">
                                    <th><input type="text" class="form-control" placeholder="Search ID"></th>
                                    <th><input type="text" class="form-control" placeholder="Search Name"></th>
                                    <th><input type="text" class="form-control" placeholder="Search Serial Number"></th>
                                    <th><input type="text" class="form-control" placeholder="Search Category"></th>
                                    <th><input type="text" class="form-control" placeholder="Search Subcategory"></th>
                                    <th><input type="text" class="form-control" placeholder="Search Owner"></th>
                                    <th><input type="text" class="form-control" placeholder="Search Status"></th>
                                    <th><input type="text" class="form-control" placeholder="Search Scan Date"></th>
                                </tr>
                                
                            </thead>
                            <tbody>
                                {% for device in room_data.devices %}
                                <tr>
                                    <td>{{ device.id }}</td>
                                    <td><a href="{% url 'device_detail' device.id %}">{{ device.name }}</a></td>
                                    <td>{{ device.serial_number }}</td>
                                    <td>{{ device.category.name }}</td>
                                    <td>{{ device.subcategory.name }}</td>
                                    <td>{{ device.owner }}</td>
                                    <td>
                                        {% if device in room_data.scanned_devices %}
                                            <span class="badge bg-success">Scanned</span>
                                        {% else %}
                                            <span class="badge bg-danger">Not Scanned</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if device in room_data.scanned_devices %}
                                            {{ device.last_scan_date|date:"Y-m-d H:i" }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endfor %}
            <div class="d-lg-none mb-3 pb-5">

            </div>
        </div>
    </div>
</div>

<!-- Add this modal for report type selection -->
<div class="modal fade" id="reportTypeModal" tabindex="-1" aria-labelledby="reportTypeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="reportTypeModalLabel">Choose Report Type</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <button class="btn btn-primary generate-report-type" data-type="pdf">PDF</button>
          <button class="btn btn-success generate-report-type" data-type="excel">Excel</button>
        </div>
      </div>
    </div>
  </div>

{% endblock %}



{% block extra_js %}
{{ block.super }}
{{ qr_scan_message|json_script:"qr-scan-message" }}
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<!-- DataTables -->
<script type="text/javascript" src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.min.js"></script><script>
document.addEventListener('DOMContentLoaded', function() {
    // DataTable initialization
    document.querySelectorAll('.table').forEach(table => {
        new DataTable(table, {
        responsive: true,
        pageLength: 10,
        lengthMenu: [[5, 10, 15, 20, 25], [5, 10, 15, 20, 25]],
        dom: '<"row"<"col-12 col-lg-6 text-center text-lg-start mb-1"li><"col-12 col-lg-6 d-flex justify-content-center justify-content-lg-end p-0 mb-1"p>>rt<"clear">',
        language: {
            search: "_INPUT_",
            searchPlaceholder: "Search...",
            lengthMenu: "Show _MENU_ per page",
            paginate: {
                first: "First",
                last: "Last",
                next: ">",
                previous: "<"
            }
        },
        order:[[0,'desc']],
        orderCellsTop: true,
        scrollX: true,
        autoWidth: true,
        columnDefs: [
            { width: '40px', targets: 0 },   // ID
            { width: '100px', targets: 1 },  // Creator
            { width: '50px', targets: 3 },   // Status
            
            { width: '80px', targets: 5 },   // Scope
        ],
        initComplete: function (settings, json) {
            this.api().columns().every(function (index) {
                let column = this;
                let input = document.querySelector('.search-row th:nth-child(' + (index + 1) + ') input, .search-row th:nth-child(' + (index + 1) + ') select');
                if (input) {
                    input.addEventListener('keyup', () => {
                        if (column.search() !== input.value) {
                            column.search(input.value).draw();
                        }
                    });
                    input.addEventListener('change', () => {
                        if (column.search() !== input.value) {
                            column.search(input.value).draw();
                        }
                    });
                }
            });
        }
    });

    });

    const qrScanMessage = JSON.parse(document.getElementById('qr-scan-message')?.textContent || '{}');
    if (qrScanMessage.text && qrScanMessage.type) {
        showAlert(qrScanMessage.text, qrScanMessage.type);
    }


    // Action buttons functionality
    document.querySelectorAll('.pause-resume').forEach(btn => {
        btn.addEventListener('click', function() {
            const inventoryId = this.getAttribute('data-inventory-id');
            const action = this.getAttribute('data-action');
            pauseResumeInventory(inventoryId, action);
        });
    });

    document.querySelectorAll('.cancel').forEach(btn => {
        btn.addEventListener('click', function() {
            const inventoryId = this.getAttribute('data-inventory-id');
            cancelInventory(inventoryId);
        });
    });

    document.querySelectorAll('.generate-report').forEach(btn => {
    btn.addEventListener('click', function() {
        const inventoryId = this.getAttribute('data-inventory-id');
        const modal = new bootstrap.Modal(document.getElementById('reportTypeModal'));
        modal.show();

        document.querySelectorAll('.generate-report-type').forEach(typeBtn => {
            typeBtn.onclick = function() {
                const reportType = this.getAttribute('data-type');
                generateReport(inventoryId, reportType);
                modal.hide();
            };
        });
    });
    });


    function pauseResumeInventory(inventoryId, action) {
    showConfirmation(
        'Confirm Action',
        `Are you sure you want to ${action} this inventory?`,
        `Yes, ${action} it!`,
        'Cancel'
    ).then((result) => {
        if (result.isConfirmed) {
            fetch('{% url "api_pause_resume_inventory" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    inventory_id: inventoryId,
                    action: action
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlertAndReload(data.message || `Inventory ${action}d successfully`,'success');
                } else {
                    showAlert(data.message || `Failed to ${action} inventory`, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('An error occurred while'+ action + 'ing the inventory', 'error');
            });
        }
    });
}

    function cancelInventory(inventoryId) {
        showConfirmation(
            'Cancel Inventory',
            'Are you sure you want to cancel this inventory? This action cannot be undone.',
            'Yes, cancel it!',
            'No, keep it'
        ).then((result) => {
            if (result.isConfirmed) {
                fetch('{% url "api_cancel_inventory" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        inventory_id: inventoryId
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlertAndReload('Inventory canceled successfully', 'success');   
                    } else {
                        showAlert(data.message || 'Failed to cancel inventory', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('An error occurred while canceling the inventory', 'error');
                });
            }
        });
    }


    function generateReport(inventoryId, reportType) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/api/inventory/${inventoryId}/generate-report/`;
        
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = getCookie('csrftoken');
        form.appendChild(csrfInput);

        const typeInput = document.createElement('input');
        typeInput.type = 'hidden';
        typeInput.name = 'report_type';
        typeInput.value = reportType;
        form.appendChild(typeInput);

        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
    }


    // Helper function to get CSRF token
    function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.min.css">
{% endblock %}
